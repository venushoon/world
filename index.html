<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ ë©”ëª¨ë¦¬ ê²Œì„ â€” Wikipedia API ì´ë¯¸ì§€ ìë™ë¡œë”©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%); }
    .board { max-width: 1400px; }
    .perspective { perspective: 1200px; }
    .card { width: 180px; height: 140px; }
    .inner { position: relative; width:100%; height:100%; transform-style: preserve-3d; transition: transform .35s; transform-origin:center; }
    .card.flipped .inner { transform: rotateY(180deg); }
    .face { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; -webkit-backface-visibility:hidden; border-radius:1rem; }
    .front { background:#fff; flex-direction:column; }
    .back { background:#fff; transform:rotateY(180deg); }
    .shadow-soft { box-shadow:0 10px 20px rgba(2,6,23,.08),0 6px 6px rgba(2,6,23,.06); }
    .spinner { width:26px; height:26px; border:3px solid #cbd5e1; border-top-color:#64748b; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body class="min-h-screen py-8 text-slate-800">
  <main class="mx-auto board px-4">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ ë©”ëª¨ë¦¬ ê²Œì„</h1>
        <p id="set-indicator" class="text-slate-600 mt-1">í˜„ì¬ ì„¸íŠ¸: <b>ëŒ€í‘œ(í˜¼í•©)</b> Â· 2í–‰ ê³ ì •</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <label class="text-sm text-slate-600">ì„¸íŠ¸
          <select id="dataset" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="classic">ëŒ€í‘œ (í˜¼í•©)</option>
            <option value="art">ì˜ˆìˆ  ì¤‘ì‹¬</option>
            <option value="landmarks">ëœë“œë§ˆí¬ ì¤‘ì‹¬</option>
            <option value="food">ìŒì‹ í¬í•¨</option>
          </select>
        </label>
        <label class="text-sm text-slate-600">ë‚œì´ë„
          <select id="difficulty" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="5">ë³´í†µ (10ì¥)</option>
            <option value="6">ì–´ë ¤ì›€ (12ì¥)</option>
            <option value="8">ë§¤ìš° ì–´ë ¤ì›€ (16ì¥)</option>
          </select>
        </label>
        <label class="text-sm text-slate-600">ì œí•œì‹œê°„
          <select id="timelimit" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="60">60ì´ˆ</option>
            <option value="90" selected>90ì´ˆ</option>
            <option value="120">120ì´ˆ</option>
            <option value="0">ë¬´ì œí•œ</option>
          </select>
        </label>
        <label class="text-sm text-slate-600 inline-flex items-center gap-2 select-none">
          <input id="useWiki" type="checkbox" class="rounded" checked>
          <span>Wikipedia APIë¡œ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</span>
        </label>
        <button id="btn-new" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold shadow-soft hover:opacity-90 active:opacity-80">ìƒˆ ê²Œì„</button>
        <button id="btn-hint" class="px-4 py-2 rounded-xl bg-white ring-1 ring-slate-200 font-semibold shadow-soft hover:bg-slate-50">ì •ë‹µ íŒíŠ¸ (3ì´ˆ)</button>
      </div>
    </header>

    <section class="flex items-center flex-wrap gap-6 mb-3">
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">ì´ë™ ìˆ˜:</span><span id="moves" class="text-lg font-bold">0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">ì„±ê³µ ìŒ:</span><span id="matches" class="text-lg font-bold">0/5</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">ì½¤ë³´:</span><span id="combo" class="text-lg font-bold">x0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">ì ìˆ˜:</span><span id="score" class="text-lg font-bold">0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">ë‚¨ì€ ì‹œê°„:</span><span id="time" class="text-lg font-bold">âˆ</span></div>
      <div class="ml-auto text-sm text-slate-500">ì •ë‹µ +10ì  + ì½¤ë³´ë³´ë„ˆìŠ¤(+5Ã—ì½¤ë³´ë‹¨ê³„), ì˜¤ë‹µ âˆ’2ì </div>
    </section>

    <section id="board" class="grid gap-4 place-items-center"></section>
  </main>

  <template id="tpl-card">
    <button class="card relative perspective rounded-2xl focus:outline-none focus:ring-4 ring-indigo-200 shadow-soft group" aria-label="ì¹´ë“œ">
      <div class="inner w-full h-full">
        <div class="face front w-full h-full flex flex-col items-center justify-center">
          <div class="text-2xl">ğŸƒ</div>
          <div class="mt-1 text-sm text-slate-500">ë’¤ì§‘ì–´ ë³´ì„¸ìš”</div>
        </div>
        <div class="face back w-full h-full flex items-center justify-center p-3"></div>
      </div>
    </button>
  </template>

  <script>
    // ===== ê³µí†µ ìœ í‹¸ =====
    const $=(s,e=document)=>e.querySelector(s);
    const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
    const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;};

    // ===== ë°ì´í„° ì„¸íŠ¸ (Wikipedia íƒ€ì´í‹€ í¬í•¨) =====
    // ê° í•­ëª©ì€ ko/en íƒ€ì´í‹€ì„ í¬í•¨í•©ë‹ˆë‹¤. ko ìš°ì„  ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ en ì‚¬ìš©.
    const DATASETS = {
      classic: [
        { id:'eiffel', ko:'ì—í íƒ‘', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'ì—í íƒ‘', title_en:'Eiffel Tower' },
        { id:'mona', ko:'ëª¨ë‚˜ë¦¬ì', hint:'Mona Lisa', img:'https://upload.wikimedia.org/wikipedia/commons/6/6a/Mona_Lisa.jpg', title_ko:'ëª¨ë‚˜ ë¦¬ì', title_en:'Mona Lisa' },
        { id:'louvre', ko:'ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€', hint:'MusÃ©e du Louvre', img:'https://upload.wikimedia.org/wikipedia/commons/a/af/Louvre_Museum_Wikimedia_Commons.jpg', title_ko:'ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€', title_en:'Louvre' },
        { id:'arc', ko:'ê°œì„ ë¬¸', hint:'Arc de Triomphe', img:'https://upload.wikimedia.org/wikipedia/commons/6/6d/Arc_de_Triomphe_Paris_Wikimedia_Commons.jpg', title_ko:'ê°œì„ ë¬¸ (íŒŒë¦¬)', title_en:'Arc de Triomphe' },
        { id:'versailles', ko:'ë² ë¥´ì‚¬ìœ  ê¶ì „', hint:'Palais de Versailles', img:'https://upload.wikimedia.org/wikipedia/commons/5/5d/Palace_of_Versailles_Wikimedia_Commons.jpg', title_ko:'ë² ë¥´ì‚¬ìœ  ê¶ì „', title_en:'Palace of Versailles' },
        { id:'notre', ko:'ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹', hint:'Notre-Dame', img:'https://upload.wikimedia.org/wikipedia/commons/a/a6/Notre_Dame_de_Paris_2013-07-24.jpg', title_ko:'íŒŒë¦¬ ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹', title_en:'Notre-Dame de Paris' },
        { id:'mont', ko:'ëª½ìƒë¯¸ì…¸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'ëª½ìƒë¯¸ì…¸', title_en:'Mont-Saint-Michel' },
        { id:'chambord', ko:'ìƒ¹ë³´ë¥´ ì„±', hint:'ChÃ¢teau de Chambord', img:'https://upload.wikimedia.org/wikipedia/commons/8/89/Chateau_Chambord.jpg', title_ko:'ìƒ¹ë³´ë¥´ ì„±', title_en:'ChÃ¢teau de Chambord' }
      ],
      art: [
        { id:'mona', ko:'ëª¨ë‚˜ë¦¬ì', hint:'Mona Lisa', img:'https://upload.wikimedia.org/wikipedia/commons/6/6a/Mona_Lisa.jpg', title_ko:'ëª¨ë‚˜ ë¦¬ì', title_en:'Mona Lisa' },
        { id:'venus', ko:'ì‚¬ëª¨íŠ¸ë¼ì¼€ì˜ ë‹ˆì¼€', hint:'Winged Victory', img:'https://upload.wikimedia.org/wikipedia/commons/3/3c/Winged_Victory_of_Samothrace_-_Louvre.jpg', title_ko:'ì‚¬ëª¨íŠ¸ë¼ì¼€ì˜ ë‹ˆì¼€', title_en:'Winged Victory of Samothrace' },
        { id:'milov', ko:'ë°€ë¡œì˜ ë¹„ë„ˆìŠ¤', hint:'Venus de Milo', img:'https://upload.wikimedia.org/wikipedia/commons/7/7d/Venus_de_Milo_Louvre_Ma399_n4.jpg', title_ko:'ë°€ë¡œì˜ ë¹„ë„ˆìŠ¤', title_en:'Venus de Milo' },
        { id:'orsee', ko:'ì˜¤ë¥´ì„¸ ë¯¸ìˆ ê´€', hint:"MusÃ©e d'Orsay", img:'https://upload.wikimedia.org/wikipedia/commons/1/1e/Mus%C3%A9e_d%27Orsay_Inside.jpg', title_ko:'ì˜¤ë¥´ì„¸ ë¯¸ìˆ ê´€', title_en:"MusÃ©e d'Orsay" },
        { id:'monet', ko:'ìˆ˜ë ¨', hint:'Monet Water Lilies', img:'https://upload.wikimedia.org/wikipedia/commons/2/2e/Monet_Water_Lilies_1916.jpg', title_ko:'ìˆ˜ë ¨ (ëª¨ë„¤)', title_en:'Water Lilies (Monet series)' },
        { id:'rodin', ko:'ìƒê°í•˜ëŠ” ì‚¬ëŒ', hint:'Rodin The Thinker', img:'https://upload.wikimedia.org/wikipedia/commons/5/5f/Le_Penseur_de_Rodin.jpg', title_ko:'ìƒê°í•˜ëŠ” ì‚¬ëŒ', title_en:'The Thinker' },
        { id:'delacroix', ko:'ë¯¼ì¤‘ì„ ì´ë„ëŠ” ììœ ì˜ ì—¬ì‹ ', hint:'Delacroix', img:'https://upload.wikimedia.org/wikipedia/commons/4/4d/Eug%C3%A8ne_Delacroix_-_La_libert%C3%A9_guidant_le_peuple.jpg', title_ko:'ë¯¼ì¤‘ì„ ì´ë„ëŠ” ììœ ì˜ ì—¬ì‹ ', title_en:'Liberty Leading the People' },
        { id:'giverny', ko:'ì§€ë² ë¥´ë‹ˆ ì •ì›', hint:'Giverny Garden', img:'https://upload.wikimedia.org/wikipedia/commons/1/12/Monet%27s_garden_in_Giverny_2012.jpg', title_ko:'ì§€ë² ë¥´ë‹ˆ', title_en:'Giverny' }
      ],
      landmarks: [
        { id:'eiffel', ko:'ì—í íƒ‘', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'ì—í íƒ‘', title_en:'Eiffel Tower' },
        { id:'notre', ko:'ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹', hint:'Notre-Dame', img:'https://upload.wikimedia.org/wikipedia/commons/a/a6/Notre_Dame_de_Paris_2013-07-24.jpg', title_ko:'íŒŒë¦¬ ë…¸íŠ¸ë¥´ë‹´ ëŒ€ì„±ë‹¹', title_en:'Notre-Dame de Paris' },
        { id:'mont', ko:'ëª½ìƒë¯¸ì…¸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'ëª½ìƒë¯¸ì…¸', title_en:'Mont-Saint-Michel' },
        { id:'arc', ko:'ê°œì„ ë¬¸', hint:'Arc de Triomphe', img:'https://upload.wikimedia.org/wikipedia/commons/6/6d/Arc_de_Triomphe_Paris_Wikimedia_Commons.jpg', title_ko:'ê°œì„ ë¬¸ (íŒŒë¦¬)', title_en:'Arc de Triomphe' },
        { id:'versailles', ko:'ë² ë¥´ì‚¬ìœ  ê¶ì „', hint:'Palais de Versailles', img:'https://upload.wikimedia.org/wikipedia/commons/5/5d/Palace_of_Versailles_Wikimedia_Commons.jpg', title_ko:'ë² ë¥´ì‚¬ìœ  ê¶ì „', title_en:'Palace of Versailles' },
        { id:'sacre', ko:'ì‚¬í¬ë ˆì¾¨ë¥´ ëŒ€ì„±ë‹¹', hint:'SacrÃ©-CÅ“ur', img:'https://upload.wikimedia.org/wikipedia/commons/6/6b/Sacre_Coeur_2011.jpg', title_ko:'ì‚¬í¬ë ˆì¾¨ë¥´ ëŒ€ì„±ë‹¹', title_en:'SacrÃ©-CÅ“ur, Paris' },
        { id:'pontgard', ko:'íë’¤ê°€ë¥´', hint:'Pont du Gard', img:'https://upload.wikimedia.org/wikipedia/commons/7/77/Pont_du_Gard_BLS.jpg', title_ko:'íë’¤ê°€ë¥´', title_en:'Pont du Gard' },
        { id:'carcassonne', ko:'ì¹´ë¥´ì¹´ì†', hint:'CitÃ© de Carcassonne', img:'https://upload.wikimedia.org/wikipedia/commons/7/70/Carcassonne_Cit%C3%A9_Walls.jpg', title_ko:'ì¹´ë¥´ì¹´ì†', title_en:'CitÃ© de Carcassonne' }
      ],
      food: [
        { id:'baguette', ko:'ë°”ê²ŒíŠ¸', hint:'Baguette', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/French_baguettes.jpg', title_ko:'ë°”ê²ŒíŠ¸', title_en:'Baguette' },
        { id:'macaron', ko:'ë§ˆì¹´ë¡±', hint:'Macaron', img:'https://upload.wikimedia.org/wikipedia/commons/0/0e/Macarons_in_Patisserie.jpg', title_ko:'ë§ˆì¹´ë¡±', title_en:'Macaron' },
        { id:'cheese', ko:'í”„ë‘ìŠ¤ ì¹˜ì¦ˆ', hint:'Fromage', img:'https://upload.wikimedia.org/wikipedia/commons/3/36/French_cheese_assortment.jpg', title_ko:'í”„ë‘ìŠ¤ ì¹˜ì¦ˆ', title_en:'French cheese' },
        { id:'crepe', ko:'í¬ë ˆí˜', hint:'CrÃªpe', img:'https://upload.wikimedia.org/wikipedia/commons/4/4b/Crepes_dsc07085.jpg', title_ko:'í¬ë ˆí˜', title_en:'CrÃªpe' },
        { id:'ratatouille', ko:'ë¼ë”°ëšœì´', hint:'Ratatouille', img:'https://upload.wikimedia.org/wikipedia/commons/5/50/Ratatouille.jpg', title_ko:'ë¼íƒ€íˆ¬ì´', title_en:'Ratatouille' },
        { id:'louvre', ko:'ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€', hint:'MusÃ©e du Louvre', img:'https://upload.wikimedia.org/wikipedia/commons/a/af/Louvre_Museum_Wikimedia_Commons.jpg', title_ko:'ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€', title_en:'Louvre' },
        { id:'eiffel', ko:'ì—í íƒ‘', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'ì—í íƒ‘', title_en:'Eiffel Tower' },
        { id:'mont', ko:'ëª½ìƒë¯¸ì…¸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'ëª½ìƒë¯¸ì…¸', title_en:'Mont-Saint-Michel' }
      ]
    };

    // ===== Wikipedia API ë¡œë” =====
    const WIKI_CACHE = new Map(); // key: lang:title:size

    async function fetchWikiThumbOne(lang, title, size){
      if(!title) return null;
      const key = `${lang}:${title}:${size}`;
      if(WIKI_CACHE.has(key)) return WIKI_CACHE.get(key);
      try{
        // 1) MediaWiki API (pageimages)
        const api = `https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=thumbnail&pithumbsize=${size}&titles=${encodeURIComponent(title)}&origin=*`;
        const r1 = await fetch(api, { referrerPolicy:'no-referrer' });
        if(r1.ok){
          const j = await r1.json();
          const pages = j.query && j.query.pages ? j.query.pages : {};
          for(const pid in pages){
            const p = pages[pid];
            if(p && p.thumbnail && p.thumbnail.source){ WIKI_CACHE.set(key, p.thumbnail.source); return p.thumbnail.source; }
          }
        }
        // 2) REST summary
        const rest = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const r2 = await fetch(rest, { referrerPolicy:'no-referrer' });
        if(r2.ok){
          const j2 = await r2.json();
          if(j2 && j2.thumbnail && j2.thumbnail.source){ WIKI_CACHE.set(key, j2.thumbnail.source); return j2.thumbnail.source; }
        }
      }catch(e){ /* ignore network errors */ }
      WIKI_CACHE.set(key, null);
      return null;
    }

    async function resolveImageURL(item, size=320){
      if(!$('#useWiki').checked) return item.img; // ì‚¬ìš©ì ë„ê¸°
      // ko ìš°ì„  â†’ en
      const u1 = await fetchWikiThumbOne('ko', item.title_ko, size);
      if(u1) return u1;
      const u2 = await fetchWikiThumbOne('en', item.title_en, size);
      if(u2) return u2;
      // ë‘˜ ë‹¤ ì‹¤íŒ¨ ì‹œ ì›ë˜ ê³ ì • URL (Wikimedia ì§ì ‘)
      return item.img;
    }

    // ===== ì‚¬ìš´ë“œ =====
    let audioCtx; function beep(f=660,d=120,t='sine',v=.2){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>o.stop(),d); }
    const sfx={ flip:()=>beep(700,70,'triangle',.07), match:()=>{beep(520,90);setTimeout(()=>beep(780,120),90)}, wrong:()=>beep(220,130,'sawtooth',.08), win:()=>[523,659,784].forEach((f,i)=>setTimeout(()=>beep(f,120),i*140)), timeup:()=>[400,300,220].forEach((f,i)=>setTimeout(()=>beep(f,180,'square',.15),i*200)) };

    // ===== ìƒíƒœ =====
    let deck=[], first=null, second=null, lock=false; let moves=0, matches=0, score=0, combo=0; let pairTarget=5; let timer=null, remain=0;

    function buildDeck(ds){
      const src=DATASETS[ds]||DATASETS.classic; const chosen=src.slice(0,pairTarget);
      return shuffle(chosen.flatMap(item=>[
        { pair:item.id, kind:'image', label:item.ko, hint:item.hint, item },
        { pair:item.id, kind:'word',  label:item.ko, hint:item.hint, item }
      ]));
    }

    function updateHUD(){ $('#moves').textContent=moves; $('#matches').textContent=`${matches}/${pairTarget}`; $('#combo').textContent=`x${combo}`; $('#score').textContent=score; $('#time').textContent=(remain===Infinity)?'âˆ':`${remain}s`; }

    function createCardEl(card, idx){
      const tpl=$('#tpl-card'); const el=tpl.content.firstElementChild.cloneNode(true);
      el.dataset.pair=card.pair; el.dataset.kind=card.kind; el.dataset.index=idx;
      const back=$('.back',el);
      if(card.kind==='image'){
        // ë¡œë”© ìŠ¤í”¼ë„ˆ
        const wrap=document.createElement('div'); wrap.className='flex flex-col items-center justify-center';
        const spn=document.createElement('div'); spn.className='spinner'; wrap.appendChild(spn);
        const cap=document.createElement('div'); cap.className='text-[11px] text-slate-500 mt-1'; cap.textContent='ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘'; wrap.appendChild(cap);
        back.appendChild(wrap);
        // ë¹„ë™ê¸° ë¡œë“œ (Wikipedia API â†’ fallback)
        resolveImageURL(card.item, 400).then(url=>{
          back.innerHTML='';
          const img=document.createElement('img');
          img.decoding='async'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous';
          img.src=url + (url.includes('?')?'&':'?') + 'v=' + Math.floor(Math.random()*1e6); // ìºì‹œ ìš°íšŒ
          img.alt=card.label + ' ì‚¬ì§„'; img.className='max-h-[110px] object-contain';
          img.onerror=()=>{ back.textContent='ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ Â· ' + card.label; back.className+=' text-xs text-slate-500 text-center'; };
          back.appendChild(img);
        });
      } else {
        const box=document.createElement('div'); box.className='text-center';
        const main=document.createElement('div'); main.className='text-lg font-bold'; main.textContent=card.label;
        const sub=document.createElement('div'); sub.className='text-xs text-slate-500 mt-1'; sub.textContent=card.hint||'';
        box.appendChild(main); box.appendChild(sub); back.appendChild(box);
      }
      el.addEventListener('click',()=>onFlip(el));
      return el;
    }

    function render(){ const board=$('#board'); board.innerHTML=''; board.style.gridTemplateColumns=`repeat(${pairTarget},minmax(0,1fr))`; const size=pairTarget>=8?'w-[150px] h-[115px]':pairTarget>=6?'w-[165px] h-[125px]':'w-[180px] h-[140px]'; deck.forEach((c,i)=>{ const el=createCardEl(c,i); el.classList.add(...size.split(' ')); board.appendChild(el); }); }

    function onFlip(el){ if(lock||el.classList.contains('matched')||el.classList.contains('flipped')) return; el.classList.add('flipped'); sfx.flip(); if(!first){ first=el; return; } second=el; lock=true; moves++; updateHUD(); const isMatch=first.dataset.pair===second.dataset.pair && first.dataset.kind!==second.dataset.kind; if(isMatch){ setTimeout(()=>{ first.classList.add('matched'); second.classList.add('matched'); first.setAttribute('disabled','true'); second.setAttribute('disabled','true'); first=second=null; lock=false; matches++; combo++; score += 10 + Math.max(0,combo-1)*5; updateHUD(); sfx.match(); if(matches===pairTarget) win(); },240); } else { setTimeout(()=>{ first.classList.remove('flipped'); second.classList.remove('flipped'); first=second=null; lock=false; score=Math.max(0,score-2); combo=0; updateHUD(); sfx.wrong(); },800);} }

    function win(){ stopTimer(); sfx.win(); alert(`ì„±ê³µ! ì ìˆ˜ ${score}ì , ì´ë™ìˆ˜ ${moves}íšŒ, ìµœê³  ì½¤ë³´ x${combo}`); }
    function timeUp(){ sfx.timeup(); alert(`ì‹œê°„ ì¢…ë£Œ! ì ìˆ˜ ${score}ì , ì„±ê³µ ${matches}/${pairTarget}`); }

    function startTimer(sec){ stopTimer(); if(sec===0){ remain=Infinity; updateHUD(); return; } remain=sec; updateHUD(); timer=setInterval(()=>{ if(remain===Infinity) return; remain--; updateHUD(); if(remain<=0){ stopTimer(); lock=true; $$('#board .card').forEach(el=>el.setAttribute('disabled','true')); timeUp(); } },1000); }
    function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

    function newGame(){ const ds=$('#dataset').value; pairTarget=parseInt($('#difficulty').value,10)||5; const tl=parseInt($('#timelimit').value,10); moves=0;matches=0;score=0;combo=0; first=second=null; lock=false; deck=buildDeck(ds); render(); startTimer(tl); $('#set-indicator').innerHTML = `í˜„ì¬ ì„¸íŠ¸: <b>${$('#dataset').selectedOptions[0].textContent}</b> Â· 2í–‰ ê³ ì •`; updateHUD(); }
    function hint3sec(){ const arr=$$('#board .card'); const show=arr.filter(el=>!el.classList.contains('matched')&&!el.classList.contains('flipped')); show.forEach(el=>el.classList.add('flipped')); setTimeout(()=>show.forEach(el=>el.classList.remove('flipped')),3000); }

    // ì´ë²¤íŠ¸
    $('#btn-new').addEventListener('click',newGame);
    $('#btn-hint').addEventListener('click',hint3sec);
    $('#dataset').addEventListener('change',newGame);
    $('#difficulty').addEventListener('change',newGame);
    $('#timelimit').addEventListener('change',newGame);
    $('#useWiki').addEventListener('change',newGame);
    newGame();
  </script>
</body>
</html>
