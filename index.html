<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🇫🇷 프랑스 메모리 게임 — Wikipedia API 이미지 자동로딩</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%); }
    .board { max-width: 1400px; }
    .perspective { perspective: 1200px; }
    .card { width: 180px; height: 140px; }
    .inner { position: relative; width:100%; height:100%; transform-style: preserve-3d; transition: transform .35s; transform-origin:center; }
    .card.flipped .inner { transform: rotateY(180deg); }
    .face { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; -webkit-backface-visibility:hidden; border-radius:1rem; }
    .front { background:#fff; flex-direction:column; }
    .back { background:#fff; transform:rotateY(180deg); }
    .shadow-soft { box-shadow:0 10px 20px rgba(2,6,23,.08),0 6px 6px rgba(2,6,23,.06); }
    .spinner { width:26px; height:26px; border:3px solid #cbd5e1; border-top-color:#64748b; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body class="min-h-screen py-8 text-slate-800">
  <main class="mx-auto board px-4">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">🇫🇷 프랑스 메모리 게임</h1>
        <p id="set-indicator" class="text-slate-600 mt-1">현재 세트: <b>대표(혼합)</b> · 2행 고정</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <label class="text-sm text-slate-600">세트
          <select id="dataset" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="classic">대표 (혼합)</option>
            <option value="art">예술 중심</option>
            <option value="landmarks">랜드마크 중심</option>
            <option value="food">음식 포함</option>
          </select>
        </label>
        <label class="text-sm text-slate-600">난이도
          <select id="difficulty" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="5">보통 (10장)</option>
            <option value="6">어려움 (12장)</option>
            <option value="8">매우 어려움 (16장)</option>
          </select>
        </label>
        <label class="text-sm text-slate-600">제한시간
          <select id="timelimit" class="ml-2 px-3 py-2 rounded-xl bg-white ring-1 ring-slate-200 shadow-soft">
            <option value="60">60초</option>
            <option value="90" selected>90초</option>
            <option value="120">120초</option>
            <option value="0">무제한</option>
          </select>
        </label>
        <label class="text-sm text-slate-600 inline-flex items-center gap-2 select-none">
          <input id="useWiki" type="checkbox" class="rounded" checked>
          <span>Wikipedia API로 이미지 불러오기</span>
        </label>
        <button id="btn-new" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold shadow-soft hover:opacity-90 active:opacity-80">새 게임</button>
        <button id="btn-hint" class="px-4 py-2 rounded-xl bg-white ring-1 ring-slate-200 font-semibold shadow-soft hover:bg-slate-50">정답 힌트 (3초)</button>
      </div>
    </header>

    <section class="flex items-center flex-wrap gap-6 mb-3">
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">이동 수:</span><span id="moves" class="text-lg font-bold">0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">성공 쌍:</span><span id="matches" class="text-lg font-bold">0/5</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">콤보:</span><span id="combo" class="text-lg font-bold">x0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">점수:</span><span id="score" class="text-lg font-bold">0</span></div>
      <div class="flex items-center gap-2 text-slate-700"><span class="text-sm">남은 시간:</span><span id="time" class="text-lg font-bold">∞</span></div>
      <div class="ml-auto text-sm text-slate-500">정답 +10점 + 콤보보너스(+5×콤보단계), 오답 −2점</div>
    </section>

    <section id="board" class="grid gap-4 place-items-center"></section>
  </main>

  <template id="tpl-card">
    <button class="card relative perspective rounded-2xl focus:outline-none focus:ring-4 ring-indigo-200 shadow-soft group" aria-label="카드">
      <div class="inner w-full h-full">
        <div class="face front w-full h-full flex flex-col items-center justify-center">
          <div class="text-2xl">🃏</div>
          <div class="mt-1 text-sm text-slate-500">뒤집어 보세요</div>
        </div>
        <div class="face back w-full h-full flex items-center justify-center p-3"></div>
      </div>
    </button>
  </template>

  <script>
    // ===== 공통 유틸 =====
    const $=(s,e=document)=>e.querySelector(s);
    const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
    const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;};

    // ===== 데이터 세트 (Wikipedia 타이틀 포함) =====
    // 각 항목은 ko/en 타이틀을 포함합니다. ko 우선 시도 후 실패 시 en 사용.
    const DATASETS = {
      classic: [
        { id:'eiffel', ko:'에펠탑', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'에펠탑', title_en:'Eiffel Tower' },
        { id:'mona', ko:'모나리자', hint:'Mona Lisa', img:'https://upload.wikimedia.org/wikipedia/commons/6/6a/Mona_Lisa.jpg', title_ko:'모나 리자', title_en:'Mona Lisa' },
        { id:'louvre', ko:'루브르 박물관', hint:'Musée du Louvre', img:'https://upload.wikimedia.org/wikipedia/commons/a/af/Louvre_Museum_Wikimedia_Commons.jpg', title_ko:'루브르 박물관', title_en:'Louvre' },
        { id:'arc', ko:'개선문', hint:'Arc de Triomphe', img:'https://upload.wikimedia.org/wikipedia/commons/6/6d/Arc_de_Triomphe_Paris_Wikimedia_Commons.jpg', title_ko:'개선문 (파리)', title_en:'Arc de Triomphe' },
        { id:'versailles', ko:'베르사유 궁전', hint:'Palais de Versailles', img:'https://upload.wikimedia.org/wikipedia/commons/5/5d/Palace_of_Versailles_Wikimedia_Commons.jpg', title_ko:'베르사유 궁전', title_en:'Palace of Versailles' },
        { id:'notre', ko:'노트르담 대성당', hint:'Notre-Dame', img:'https://upload.wikimedia.org/wikipedia/commons/a/a6/Notre_Dame_de_Paris_2013-07-24.jpg', title_ko:'파리 노트르담 대성당', title_en:'Notre-Dame de Paris' },
        { id:'mont', ko:'몽생미셸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'몽생미셸', title_en:'Mont-Saint-Michel' },
        { id:'chambord', ko:'샹보르 성', hint:'Château de Chambord', img:'https://upload.wikimedia.org/wikipedia/commons/8/89/Chateau_Chambord.jpg', title_ko:'샹보르 성', title_en:'Château de Chambord' }
      ],
      art: [
        { id:'mona', ko:'모나리자', hint:'Mona Lisa', img:'https://upload.wikimedia.org/wikipedia/commons/6/6a/Mona_Lisa.jpg', title_ko:'모나 리자', title_en:'Mona Lisa' },
        { id:'venus', ko:'사모트라케의 니케', hint:'Winged Victory', img:'https://upload.wikimedia.org/wikipedia/commons/3/3c/Winged_Victory_of_Samothrace_-_Louvre.jpg', title_ko:'사모트라케의 니케', title_en:'Winged Victory of Samothrace' },
        { id:'milov', ko:'밀로의 비너스', hint:'Venus de Milo', img:'https://upload.wikimedia.org/wikipedia/commons/7/7d/Venus_de_Milo_Louvre_Ma399_n4.jpg', title_ko:'밀로의 비너스', title_en:'Venus de Milo' },
        { id:'orsee', ko:'오르세 미술관', hint:"Musée d'Orsay", img:'https://upload.wikimedia.org/wikipedia/commons/1/1e/Mus%C3%A9e_d%27Orsay_Inside.jpg', title_ko:'오르세 미술관', title_en:"Musée d'Orsay" },
        { id:'monet', ko:'수련', hint:'Monet Water Lilies', img:'https://upload.wikimedia.org/wikipedia/commons/2/2e/Monet_Water_Lilies_1916.jpg', title_ko:'수련 (모네)', title_en:'Water Lilies (Monet series)' },
        { id:'rodin', ko:'생각하는 사람', hint:'Rodin The Thinker', img:'https://upload.wikimedia.org/wikipedia/commons/5/5f/Le_Penseur_de_Rodin.jpg', title_ko:'생각하는 사람', title_en:'The Thinker' },
        { id:'delacroix', ko:'민중을 이끄는 자유의 여신', hint:'Delacroix', img:'https://upload.wikimedia.org/wikipedia/commons/4/4d/Eug%C3%A8ne_Delacroix_-_La_libert%C3%A9_guidant_le_peuple.jpg', title_ko:'민중을 이끄는 자유의 여신', title_en:'Liberty Leading the People' },
        { id:'giverny', ko:'지베르니 정원', hint:'Giverny Garden', img:'https://upload.wikimedia.org/wikipedia/commons/1/12/Monet%27s_garden_in_Giverny_2012.jpg', title_ko:'지베르니', title_en:'Giverny' }
      ],
      landmarks: [
        { id:'eiffel', ko:'에펠탑', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'에펠탑', title_en:'Eiffel Tower' },
        { id:'notre', ko:'노트르담 대성당', hint:'Notre-Dame', img:'https://upload.wikimedia.org/wikipedia/commons/a/a6/Notre_Dame_de_Paris_2013-07-24.jpg', title_ko:'파리 노트르담 대성당', title_en:'Notre-Dame de Paris' },
        { id:'mont', ko:'몽생미셸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'몽생미셸', title_en:'Mont-Saint-Michel' },
        { id:'arc', ko:'개선문', hint:'Arc de Triomphe', img:'https://upload.wikimedia.org/wikipedia/commons/6/6d/Arc_de_Triomphe_Paris_Wikimedia_Commons.jpg', title_ko:'개선문 (파리)', title_en:'Arc de Triomphe' },
        { id:'versailles', ko:'베르사유 궁전', hint:'Palais de Versailles', img:'https://upload.wikimedia.org/wikipedia/commons/5/5d/Palace_of_Versailles_Wikimedia_Commons.jpg', title_ko:'베르사유 궁전', title_en:'Palace of Versailles' },
        { id:'sacre', ko:'사크레쾨르 대성당', hint:'Sacré-Cœur', img:'https://upload.wikimedia.org/wikipedia/commons/6/6b/Sacre_Coeur_2011.jpg', title_ko:'사크레쾨르 대성당', title_en:'Sacré-Cœur, Paris' },
        { id:'pontgard', ko:'퐁뒤가르', hint:'Pont du Gard', img:'https://upload.wikimedia.org/wikipedia/commons/7/77/Pont_du_Gard_BLS.jpg', title_ko:'퐁뒤가르', title_en:'Pont du Gard' },
        { id:'carcassonne', ko:'카르카손', hint:'Cité de Carcassonne', img:'https://upload.wikimedia.org/wikipedia/commons/7/70/Carcassonne_Cit%C3%A9_Walls.jpg', title_ko:'카르카손', title_en:'Cité de Carcassonne' }
      ],
      food: [
        { id:'baguette', ko:'바게트', hint:'Baguette', img:'https://upload.wikimedia.org/wikipedia/commons/3/34/French_baguettes.jpg', title_ko:'바게트', title_en:'Baguette' },
        { id:'macaron', ko:'마카롱', hint:'Macaron', img:'https://upload.wikimedia.org/wikipedia/commons/0/0e/Macarons_in_Patisserie.jpg', title_ko:'마카롱', title_en:'Macaron' },
        { id:'cheese', ko:'프랑스 치즈', hint:'Fromage', img:'https://upload.wikimedia.org/wikipedia/commons/3/36/French_cheese_assortment.jpg', title_ko:'프랑스 치즈', title_en:'French cheese' },
        { id:'crepe', ko:'크레페', hint:'Crêpe', img:'https://upload.wikimedia.org/wikipedia/commons/4/4b/Crepes_dsc07085.jpg', title_ko:'크레페', title_en:'Crêpe' },
        { id:'ratatouille', ko:'라따뚜이', hint:'Ratatouille', img:'https://upload.wikimedia.org/wikipedia/commons/5/50/Ratatouille.jpg', title_ko:'라타투이', title_en:'Ratatouille' },
        { id:'louvre', ko:'루브르 박물관', hint:'Musée du Louvre', img:'https://upload.wikimedia.org/wikipedia/commons/a/af/Louvre_Museum_Wikimedia_Commons.jpg', title_ko:'루브르 박물관', title_en:'Louvre' },
        { id:'eiffel', ko:'에펠탑', hint:'Tour Eiffel', img:'https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg', title_ko:'에펠탑', title_en:'Eiffel Tower' },
        { id:'mont', ko:'몽생미셸', hint:'Mont-Saint-Michel', img:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mont-Saint-Michel_from_above.jpg', title_ko:'몽생미셸', title_en:'Mont-Saint-Michel' }
      ]
    };

    // ===== Wikipedia API 로더 =====
    const WIKI_CACHE = new Map(); // key: lang:title:size

    async function fetchWikiThumbOne(lang, title, size){
      if(!title) return null;
      const key = `${lang}:${title}:${size}`;
      if(WIKI_CACHE.has(key)) return WIKI_CACHE.get(key);
      try{
        // 1) MediaWiki API (pageimages)
        const api = `https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=thumbnail&pithumbsize=${size}&titles=${encodeURIComponent(title)}&origin=*`;
        const r1 = await fetch(api, { referrerPolicy:'no-referrer' });
        if(r1.ok){
          const j = await r1.json();
          const pages = j.query && j.query.pages ? j.query.pages : {};
          for(const pid in pages){
            const p = pages[pid];
            if(p && p.thumbnail && p.thumbnail.source){ WIKI_CACHE.set(key, p.thumbnail.source); return p.thumbnail.source; }
          }
        }
        // 2) REST summary
        const rest = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const r2 = await fetch(rest, { referrerPolicy:'no-referrer' });
        if(r2.ok){
          const j2 = await r2.json();
          if(j2 && j2.thumbnail && j2.thumbnail.source){ WIKI_CACHE.set(key, j2.thumbnail.source); return j2.thumbnail.source; }
        }
      }catch(e){ /* ignore network errors */ }
      WIKI_CACHE.set(key, null);
      return null;
    }

    async function resolveImageURL(item, size=320){
      if(!$('#useWiki').checked) return item.img; // 사용자 끄기
      // ko 우선 → en
      const u1 = await fetchWikiThumbOne('ko', item.title_ko, size);
      if(u1) return u1;
      const u2 = await fetchWikiThumbOne('en', item.title_en, size);
      if(u2) return u2;
      // 둘 다 실패 시 원래 고정 URL (Wikimedia 직접)
      return item.img;
    }

    // ===== 사운드 =====
    let audioCtx; function beep(f=660,d=120,t='sine',v=.2){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>o.stop(),d); }
    const sfx={ flip:()=>beep(700,70,'triangle',.07), match:()=>{beep(520,90);setTimeout(()=>beep(780,120),90)}, wrong:()=>beep(220,130,'sawtooth',.08), win:()=>[523,659,784].forEach((f,i)=>setTimeout(()=>beep(f,120),i*140)), timeup:()=>[400,300,220].forEach((f,i)=>setTimeout(()=>beep(f,180,'square',.15),i*200)) };

    // ===== 상태 =====
    let deck=[], first=null, second=null, lock=false; let moves=0, matches=0, score=0, combo=0; let pairTarget=5; let timer=null, remain=0;

    function buildDeck(ds){
      const src=DATASETS[ds]||DATASETS.classic; const chosen=src.slice(0,pairTarget);
      return shuffle(chosen.flatMap(item=>[
        { pair:item.id, kind:'image', label:item.ko, hint:item.hint, item },
        { pair:item.id, kind:'word',  label:item.ko, hint:item.hint, item }
      ]));
    }

    function updateHUD(){ $('#moves').textContent=moves; $('#matches').textContent=`${matches}/${pairTarget}`; $('#combo').textContent=`x${combo}`; $('#score').textContent=score; $('#time').textContent=(remain===Infinity)?'∞':`${remain}s`; }

    function createCardEl(card, idx){
      const tpl=$('#tpl-card'); const el=tpl.content.firstElementChild.cloneNode(true);
      el.dataset.pair=card.pair; el.dataset.kind=card.kind; el.dataset.index=idx;
      const back=$('.back',el);
      if(card.kind==='image'){
        // 로딩 스피너
        const wrap=document.createElement('div'); wrap.className='flex flex-col items-center justify-center';
        const spn=document.createElement('div'); spn.className='spinner'; wrap.appendChild(spn);
        const cap=document.createElement('div'); cap.className='text-[11px] text-slate-500 mt-1'; cap.textContent='이미지 불러오는 중'; wrap.appendChild(cap);
        back.appendChild(wrap);
        // 비동기 로드 (Wikipedia API → fallback)
        resolveImageURL(card.item, 400).then(url=>{
          back.innerHTML='';
          const img=document.createElement('img');
          img.decoding='async'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous';
          img.src=url + (url.includes('?')?'&':'?') + 'v=' + Math.floor(Math.random()*1e6); // 캐시 우회
          img.alt=card.label + ' 사진'; img.className='max-h-[110px] object-contain';
          img.onerror=()=>{ back.textContent='이미지 로딩 실패 · ' + card.label; back.className+=' text-xs text-slate-500 text-center'; };
          back.appendChild(img);
        });
      } else {
        const box=document.createElement('div'); box.className='text-center';
        const main=document.createElement('div'); main.className='text-lg font-bold'; main.textContent=card.label;
        const sub=document.createElement('div'); sub.className='text-xs text-slate-500 mt-1'; sub.textContent=card.hint||'';
        box.appendChild(main); box.appendChild(sub); back.appendChild(box);
      }
      el.addEventListener('click',()=>onFlip(el));
      return el;
    }

    function render(){ const board=$('#board'); board.innerHTML=''; board.style.gridTemplateColumns=`repeat(${pairTarget},minmax(0,1fr))`; const size=pairTarget>=8?'w-[150px] h-[115px]':pairTarget>=6?'w-[165px] h-[125px]':'w-[180px] h-[140px]'; deck.forEach((c,i)=>{ const el=createCardEl(c,i); el.classList.add(...size.split(' ')); board.appendChild(el); }); }

    function onFlip(el){ if(lock||el.classList.contains('matched')||el.classList.contains('flipped')) return; el.classList.add('flipped'); sfx.flip(); if(!first){ first=el; return; } second=el; lock=true; moves++; updateHUD(); const isMatch=first.dataset.pair===second.dataset.pair && first.dataset.kind!==second.dataset.kind; if(isMatch){ setTimeout(()=>{ first.classList.add('matched'); second.classList.add('matched'); first.setAttribute('disabled','true'); second.setAttribute('disabled','true'); first=second=null; lock=false; matches++; combo++; score += 10 + Math.max(0,combo-1)*5; updateHUD(); sfx.match(); if(matches===pairTarget) win(); },240); } else { setTimeout(()=>{ first.classList.remove('flipped'); second.classList.remove('flipped'); first=second=null; lock=false; score=Math.max(0,score-2); combo=0; updateHUD(); sfx.wrong(); },800);} }

    function win(){ stopTimer(); sfx.win(); alert(`성공! 점수 ${score}점, 이동수 ${moves}회, 최고 콤보 x${combo}`); }
    function timeUp(){ sfx.timeup(); alert(`시간 종료! 점수 ${score}점, 성공 ${matches}/${pairTarget}`); }

    function startTimer(sec){ stopTimer(); if(sec===0){ remain=Infinity; updateHUD(); return; } remain=sec; updateHUD(); timer=setInterval(()=>{ if(remain===Infinity) return; remain--; updateHUD(); if(remain<=0){ stopTimer(); lock=true; $$('#board .card').forEach(el=>el.setAttribute('disabled','true')); timeUp(); } },1000); }
    function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

    function newGame(){ const ds=$('#dataset').value; pairTarget=parseInt($('#difficulty').value,10)||5; const tl=parseInt($('#timelimit').value,10); moves=0;matches=0;score=0;combo=0; first=second=null; lock=false; deck=buildDeck(ds); render(); startTimer(tl); $('#set-indicator').innerHTML = `현재 세트: <b>${$('#dataset').selectedOptions[0].textContent}</b> · 2행 고정`; updateHUD(); }
    function hint3sec(){ const arr=$$('#board .card'); const show=arr.filter(el=>!el.classList.contains('matched')&&!el.classList.contains('flipped')); show.forEach(el=>el.classList.add('flipped')); setTimeout(()=>show.forEach(el=>el.classList.remove('flipped')),3000); }

    // 이벤트
    $('#btn-new').addEventListener('click',newGame);
    $('#btn-hint').addEventListener('click',hint3sec);
    $('#dataset').addEventListener('change',newGame);
    $('#difficulty').addEventListener('change',newGame);
    $('#timelimit').addEventListener('change',newGame);
    $('#useWiki').addEventListener('change',newGame);
    newGame();
  </script>
</body>
</html>
